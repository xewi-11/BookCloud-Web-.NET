@using BookCloud.Models.ViewModels
@model CarritoViewModel

@{
    ViewData["Title"] = "Mi Carrito";
}

<div class="container carrito-container">
    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["Mensaje"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="section-title mb-0">
            <i class="bi bi-cart3"></i> Mi Carrito
        </h1>
        @if (Model.TieneItems)
        {
            <span class="badge badge-gold" style="font-size: 1.2rem;">
                @Model.TotalItems items
            </span>
        }
    </div>

    @if (Model.TieneItems)
    {
        <div class="row g-4">
            <!-- Lista de items del carrito -->
            <div class="col-lg-8">
                <!-- Cada item es ahora una carta separada -->
                @foreach (var item in Model.Items)
                {
                    <div class="carrito-item">
                        <div class="carrito-item-image">
                            <img src="@(item.Foto ?? "/images/default-book.jpg")" 
                                 alt="@item.Titulo" />
                        </div>

                        <div class="carrito-item-details">
                            <h5 class="carrito-item-title">@item.Titulo</h5>
                            <p class="carrito-item-author">
                                <i class="bi bi-person"></i> @item.Autor
                            </p>
                            <div class="carrito-item-price">
                                $@item.Precio.ToString("N2") c/u
                            </div>
                            @if (item.StockDisponible < 5)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    Solo @item.StockDisponible disponibles
                                </span>
                            }
                            <div class="carrito-item-actions">
                                <!-- Control de cantidad -->
                                <div class="quantity-control">
                                    <form asp-action="ActualizarCantidad" method="post" class="d-inline">
                                        <input type="hidden" name="libroId" value="@item.LibroId" />
                                        <input type="hidden" name="cantidad" value="@(item.Cantidad - 1)" />
                                        <button type="submit" 
                                                class="btn btn-quantity" 
                                                @(item.Cantidad <= 1 ? "disabled" : "")>
                                            <i class="bi bi-dash"></i>
                                        </form>

                                        <span class="quantity-display">@item.Cantidad</span>

                                        <form asp-action="ActualizarCantidad" method="post" class="d-inline">
                                            <input type="hidden" name="libroId" value="@item.LibroId" />
                                            <input type="hidden" name="cantidad" value="@(item.Cantidad + 1)" />
                                            <button type="submit" 
                                                    class="btn btn-quantity" 
                                                    @(item.Cantidad >= item.StockDisponible ? "disabled" : "")>
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- Subtotal -->
                                    <div class="carrito-item-subtotal">
                                        $@item.Subtotal.ToString("N2")
                                    </div>

                                    <!-- Botón eliminar -->
                                    <form asp-action="EliminarItem" method="post">
                                        <input type="hidden" name="libroId" value="@item.LibroId" />
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        
                    </div>
                }

                <!-- Botón limpiar carrito -->
                <div class="mt-3">
                    <form asp-action="LimpiarCarrito" method="post" onsubmit="return confirm('¿Estás seguro de vaciar el carrito?');">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash3"></i> Vaciar carrito
                        </button>
                    </form>
                </div>
            </div>

            <!-- Resumen del pedido -->
            <div class="col-lg-4">
                <div class="card carrito-summary">
                    <div class="card-header">
                        <i class="bi bi-receipt"></i> Resumen del Pedido
                    </div>
                    <div class="card-body">
                        <div class="summary-row">
                            <span>Subtotal (@Model.TotalItems items):</span>
                            <span class="summary-value">$@Model.Total.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span>Envío:</span>
                            <span class="summary-value text-success">GRATIS</span>
                        </div>
                        <hr class="summary-divider" />
                        <div class="summary-row summary-total">
                            <span>Total:</span>
                            <span class="summary-value">$@Model.Total.ToString("N2")</span>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <a asp-controller="Pedido" asp-action="SeleccionarMetodoPago" class="btn btn-primary btn-lg">
                                <i class="bi bi-credit-card"></i> Proceder al Pago
                            </a>
                            <a asp-controller="Libro" asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Seguir Comprando
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Información adicional -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="text-gold">
                            <i class="bi bi-shield-check"></i> Compra Segura
                        </h6>
                        <ul class="list-unstyled small text-muted mb-0">
                            <li><i class="bi bi-check2"></i> Pago seguro con Wallet o Tarjeta</li>
                            <li><i class="bi bi-check2"></i> Envío gratis en todos los pedidos</li>
                            <li><i class="bi bi-check2"></i> Garantía de devolución</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Carrito vacío -->
        <div class="empty-cart">
            <i class="bi bi-cart-x"></i>
            <h3>Tu carrito está vacío</h3>
            <p class="text-muted">Explora nuestro catálogo y encuentra los mejores libros</p>
            <a asp-controller="Libro" asp-action="Index" class="btn btn-primary mt-3">
                <i class="bi bi-book"></i> Ver Catálogo
            </a>
        </div>
    }
</div>